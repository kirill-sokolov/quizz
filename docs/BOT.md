# Telegram Bot

## Технический стек

- **grammy** — Telegram Bot framework
- **Long polling** (не webhook)
- Отдельный сервис: `apps/bot/`
- Подключается к API через REST + WebSocket

## Структура

```
apps/bot/src/
├── index.ts            # Точка входа, запуск grammy + WS listener
├── config.ts           # BOT_TOKEN, API_URL
├── state.ts            # In-memory состояние пользователей
├── api-client.ts       # Обращения к Backend API
├── ws-listener.ts      # WebSocket: получает события и отправляет сообщения
└── handlers/
    ├── start.ts        # /start — регистрация команды
    └── captain.ts      # Ответы: inline keyboard + текстовый ввод
```

---

## Flow взаимодействия

### 1. Регистрация команды

```
Капитан → /start ABC123
  ↓
Бот → "Введи название команды:"
  ↓
Капитан → "Команда Алексея"
  ↓
Бот → API: POST /bot/register-team
  ↓
API → WebSocket: team_registered
  ↓
Бот → "Команда «Алексея» зарегистрирована! ✅ Жди начала квиза."
```

> Если по коду найдено несколько квизов — бот предлагает выбрать из inline-кнопок.

---

### 2. Получение вопроса (только на слайде таймера)

```
Ведущий переключает слайд → "timer"
  ↓
API → WebSocket: slide_changed { slide: "timer" }
  ↓
Бот (ws-listener) → отправляет вопрос всем капитанам квиза
```

> На слайде `"question"` бот **молчит** — только запоминает questionId.
> Сообщение приходит капитану только при переходе на `"timer"`.

**Сообщение для choice-вопроса:**
```
⏱ Время пошло!

❓ Вопрос

Сколько лет Ивану?

A) 25
B) 28
C) 30
D) 32

Выбери вариант кнопками ниже.
```
+ inline-кнопки: `A  B` / `C  D`

**Сообщение для text-вопроса:**
```
⏱ Время пошло!

❓ Вопрос

Перечислите 5 любимых фильмов Ивана.

✏️ Напиши ответ текстом.
```

---

### 3. Отправка ответа

**Choice:** нажатие inline-кнопки `A/B/C/D`
- После нажатия кнопка меняется: `✅ B`
- Повторное нажатие: "Ты уже ответил ✅"

**Text:** обычное текстовое сообщение в чат

**Фоллбек (капитан зарегался после показа вопроса):** если капитан в состоянии `registered` и присылает букву/текст — бот пробует принять ответ через API.

---

### 4. Результат вопроса

При переходе на слайд `"answer"` капитаны получают:

**Choice:**
```
Твой ответ: B ✅ Правильно!
```
или
```
Твой ответ: A ❌ Неправильно. Правильный ответ: B
```

**Text:**
```
Твой ответ: красный, синий
Оценка: 0.5/1
```

---

### 5. Завершение квиза

При событии `quiz_finished` каждой команде отправляется:
1. Общая таблица результатов (место + баллы по всем командам)
2. Детальный отчёт своей команды (по каждому вопросу)

---

### 6. Напоминание

Ведущий нажимает "Напомнить" в Admin → API → WebSocket: `remind`
```
⏰ Ведущий напоминает: сдай ответ!
```
+ inline-кнопки ответа (если вопрос choice)

---

## Переменные окружения

```env
BOT_TOKEN=123456:ABC-DEF...
API_URL=http://wedding_api:3000
```

---

## Состояния пользователя (`state.ts`)

| step | Описание |
|------|----------|
| `idle` | Не зарегистрирован |
| `awaiting_name` | Ожидает ввода названия команды |
| `registered` | Зарегистрирован, ждёт вопрос |
| `awaiting_answer` | Ожидает ответ на текущий вопрос |

---

## См. также
- [API.md](./API.md) — Endpoints для бота
- [WEBSOCKET.md](./WEBSOCKET.md) — WebSocket события
- [QUIZ-FLOW.md](./QUIZ-FLOW.md) — Жизненный цикл квиза

# Telegram Bot

## Команды

### `/start CODE`
Регистрация команды по коду квиза.

**Пример:**
```
/start ABC123
```

**Поведение:**
1. Бот спрашивает название команды
2. Пользователь вводит название
3. Бот регистрирует команду в квизе
4. Отправляет подтверждение

**Ответ бота:**
```
✅ Команда "Команда Алексея" зарегистрирована!
Ожидайте начала квиза.
```

---

### `/answer LETTER` или `/answer TEXT`
Отправить ответ на текущий вопрос.

**Примеры:**
```
/answer B
/answer красный, синий, зелёный
```

**Поведение:**
1. Проверяется, что квиз в статусе `playing` и слайд = `timer`
2. Проверяется, что команда ещё не ответила на этот вопрос
3. Сохраняется ответ в БД
4. Отправляется подтверждение

**Ответ бота:**
```
✅ Ответ принят!
```

**Ошибки:**
```
❌ Вопрос ещё не начался. Ожидайте.
❌ Вы уже ответили на этот вопрос.
❌ Время вышло!
```

---

## Flow взаимодействия

### 1. Регистрация
```
Капитан → /start CODE
  ↓
Бот → "Введите название команды:"
  ↓
Капитан → "Команда Алексея"
  ↓
Бот → API: POST /bot/register-team
  ↓
API → WebSocket: team_registered
  ↓
Бот → "✅ Команда зарегистрирована!"
```

### 2. Получение вопроса
```
Ведущий переключает слайд на "timer"
  ↓
API → WebSocket: slide_changed (slide=timer)
  ↓
Bot Service → отправка вопроса всем командам через Telegram
  ↓
Команды получают:
  - Текст вопроса
  - Варианты ответа (если choice)
  - Время на ответ
```

### 3. Отправка ответа
```
Капитан → /answer B
  ↓
Бот → API: POST /bot/submit-answer
  ↓
API → сохранение в БД (answers table)
  ↓
Бот → "✅ Ответ принят!"
```

### 4. Напоминание
```
Ведущий → "Remind" (для всех или одной команды)
  ↓
API → POST /game/remind
  ↓
Bot Service → отправка напоминания через Telegram
  ↓
Команда → "⏰ Напоминаем: у вас осталось время!"
```

---

## Webhook

### URL
`POST https://your-domain.com/api/webhook`

### Регистрация webhook
```bash
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-domain.com/api/webhook"}'
```

### Формат payload
```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": {
      "id": 12345678,
      "first_name": "Алексей",
      "username": "aleksey"
    },
    "chat": {
      "id": 12345678,
      "type": "private"
    },
    "date": 1708876800,
    "text": "/start ABC123"
  }
}
```

---

## Обработка команд

### Файл: `apps/api/src/bot/index.ts`

```typescript
bot.onText(/\/start (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const joinCode = match?.[1];

  // Найти квиз по коду
  // Спросить название команды
  // Зарегистрировать команду
});

bot.onText(/\/answer (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const answerText = match?.[1];

  // Найти команду по chatId
  // Проверить что квиз в статусе playing, слайд = timer
  // Сохранить ответ
});
```

---

## Отправка вопросов командам

### Триггер
Когда слайд переключается на `timer`, бот автоматически отправляет вопрос всем командам.

### Формат сообщения
**Choice вопрос:**
```
❓ Вопрос 5 из 20

Сколько лет Ивану?

A. 25
B. 28
C. 30
D. 32

⏱ У вас 30 секунд

Отправьте ответ: /answer A
```

**Text вопрос:**
```
❓ Вопрос 10 из 20

Перечислите 5 любимых фильмов Ивана.

⏱ У вас 60 секунд

Отправьте ответ: /answer <ваш текст>
```

---

## Переменные окружения

```env
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
WEBHOOK_URL=https://your-domain.com/api/webhook
```

## См. также
- [API.md](./API.md) — Endpoints для бота
- [QUIZ-FLOW.md](./QUIZ-FLOW.md) — Жизненный цикл квиза

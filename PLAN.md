## Реализовать фичи

### Этап 1 ✅ ВЫПОЛНЕНО
- ~~полностью выпедить OCR ото всюду, больше не использовать~~
  (сестра будет делать более четкий docx + slides)

### Этап 2
- Web TV: QR код больше - максимум доступного пространства
- Web TV: на слайде регистрации убрать цифры команд, подумать как красиво оформить

### Этап 3
- Web TV: на слайде результатов — шрифт больше (возможно, даже в 2 раза)
- Web TV: на слайде результатов - сначала появляется 2 место, потом 3, потом 4 и так до конца, и последним появляется 1 место.

### Этап 4
- Web TV + Web Admin: на слайде результатов места появляются при клике из админке

### Этап 5
- Telegram Bot: капитаны получают вопрос только на слайде таймера, на слайде вопроса ничего не должно приходить

### Этап 6
- API: поменять api при оценке ответа из TG бота (текстового)
  (валидировать текст ответов, проверить логику размера шагов в select, возможно, добавить новое поле тип количество правильных)
  (засчитывать только первые варианты, если человек ввел больше)

### Этап 7
- Web Admin + TV: в конце добавляется слайд "спасибо", он будет скорее всего всегда, но, если вдруг не будет — не показывать
- Web Admin + TV: после спасибо возможен еще 1 слайд, если вдруг не будет — не показывать

### Этап 8
- Web Admin + TV: возможность добавлять дополнительные слайды между основными (часто шутки), с поддержкой mp4

### Этап 9
- Web Admin улучшить seed Demo quiz, чтобы покрывать полностью все острые углу

---

## Тесты

Цель: покрыть текущее поведение (characterization tests), чтобы безопасно рефакторить и добавлять фичи.

### Шаг 1: Инфраструктура тестов

- Выбрать и настроить тест-раннер (Vitest — работает с ESM из коробки, быстрый)
- Настроить тестовую БД PostgreSQL (отдельная база `quiz_test`, миграции перед тестами)
- Настроить тестовый Redis (отдельный db index или prefix)
- Добавить скрипты в package.json: `test`, `test:watch`, `test:coverage`
- Настроить seed-данные: минимальный квиз (2-3 вопроса), 2-3 команды

### Шаг 2: Моки внешних сервисов

- Замокать Telegram API (bot.telegram.sendMessage и т.д.) — логировать вызовы вместо реальной отправки
- Замокать Gemini API — возвращать фиксированный JSON для тестов импорта
- Создать хелпер для генерации fake Telegram Update объектов (message, callback_query)

### Шаг 3: Интеграционные тесты API (приоритет — максимальное покрытие)

Тестировать через Fastify `inject()` — без реального HTTP, быстро и надёжно.

**Квиз lifecycle:**
- Создание квиза (POST)
- Получение квиза по ID
- Список квизов
- Удаление квиза

**Регистрация команд:**
- Команда регистрируется через fake webhook update (`/register Команда_1`)
- Повторная регистрация — ошибка или обновление имени (зафиксировать текущее поведение)
- Кик команды из админки — команда больше не участвует

**Игровой процесс:**
- Старт вопроса из админки → проверить что состояние квиза обновилось
- Переключение слайдов (вопрос → таймер → ответ → статистика)
- Отправка ответа командой — текстовый ответ через fake webhook
- Отправка ответа после истечения таймера — должен отклоняться
- Повторная отправка ответа — зафиксировать текущее поведение (перезаписывается? игнорируется?)

**Подсчёт результатов:**
- Правильный ответ → очки начисляются
- Неправильный → 0 очков
- Итоговая таблица — порядок мест корректный
- Ничья — зафиксировать текущую логику

### Шаг 4: WebSocket тесты

- Подключение клиента (admin, tv) — получает текущее состояние
- При смене слайда — все подключённые клиенты получают событие
- При отправке ответа командой — админ получает обновление в реальном времени
- Отключение и переподключение — клиент получает актуальное состояние

### Шаг 5: Юнит-тесты на бизнес-логику

Выделить и протестировать чистые функции (особенно из больших файлов):
- Валидация ответов (текст, select, количество вариантов)
- Подсчёт очков
- Формирование таблицы результатов и мест
- Парсинг docx / маппинг слайдов (если есть чистая логика)
- Логика таймера (расчёт оставшегося времени)

### Шаг 6: Тесты фронтенда (минимум, опционально)

- Smoke-тесты: основные компоненты рендерятся без ошибок (React Testing Library)
- Web TV: правильный слайд отображается для каждого состояния квиза
- Web Admin: кнопки управления вызывают правильные API-методы

### Шаг 7: Нагрузочный тест

- Скрипт симуляции 20 команд: fake Telegram updates на webhook
- Полный сценарий: регистрация → ответы на все вопросы → финальные результаты
- Проверить: нет race conditions, ответы не теряются, результаты корректные
- Проверить WebSocket: 20+ подключений, все получают события
- Проверить таймер: не съезжает при параллельных запросах и при задержках сети

### Критерии готовности

- [ ] Все тесты шагов 3-4 зелёные
- [ ] Coverage бизнес-логики бэкенда > 70%
- [ ] Нагрузочный тест: 20 команд проходят полный цикл без ошибок
- [ ] Тесты запускаются одной командой (`npm test`)
- [ ] Тесты проходят < 30 секунд

---

## Опционально в будущем

- Web Admin: вести на телефоне должно быть удобно (проверить и поправить дизайн)
- Web Admin: единый стиль админки с брендбука (lovable)
- Web Admin: затраты красивые графики, остаток счета API, красным если меньше 5$
- Web TV: статитстика самые быстрые (может еще какие номинации)
- Web Admin: разные шаблоны вывода результатов (где-то fade-in, где-то карточки мест переворачиваются)

## Деплой

- github actions
- Настроить деплой на VPS
- Написать инструкцию для ведущего (1 страница A4)

### ✅ Проверка

- 20 одновременных команд работают без ошибок
- Деплой проходит одной командой
- Инструкция написана и понятна нетехническому пользователю

---

### Порядок работы для Claude Code

Работай строго поэтапно. После завершения каждого этапа:

- обнови всю нужную документацию
- Выведи список того, что было сделано
- Опиши как проверить (команды для запуска тестов или curl)
- Жди команды "продолжай" перед переходом к следующему этапу
